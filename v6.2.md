# V6.2 Plan — Progressive Three-Way Reconciliation (Payments)

Owner: Product Co-Owners  
Status: Approved for implementation handoff  
Date: 2026-02-16

## 1) Why V6.2 Exists
LanceIQ’s strongest sticky value is not just “did we receive a webhook,” but:
- did the provider show payment success,
- did LanceIQ receive and attempt delivery,
- did the customer app actually activate the payment outcome.

V6.2 turns reconciliation into this **three-way operational truth layer** while keeping legal scope clean.

## 2) Non-Negotiable Legal Posture
LanceIQ proves:
1. Receipt by LanceIQ.
2. Verification status computed by LanceIQ.
3. Delivery attempts observed by LanceIQ.
4. Customer-reported downstream state snapshots (when configured and signed).

LanceIQ does **not** prove:
1. Provider intent.
2. Guaranteed customer processing success.
3. Financial settlement truth.

### Mandatory 2-way copy rule
In 2-way mode, UI/API must explicitly show:

**“Downstream activation status not configured.”**

Do not label 2-way gaps as “activation mismatch.”

## 3) Product Decisions Locked
1. Reconciliation is available on **Pro + Team**.
2. **Progressive mode** for Pro:
   - immediate value with 2-way reconciliation,
   - 3-way turns on after downstream snapshot setup.
3. Team remains differentiated by governance controls (SSO/SCIM/audit/legal hold/access review/SLA/etc).
4. Three-way primary join key: **provider payment ID**.
5. Confirmed mismatch grace window: **15 minutes**.
6. Mismatch handling: **alert + replay + case queue**.
7. Downstream states (V6.2): `activated`, `not_activated`, `error` (+ optional reason code).
8. Snapshot auth: **per-workspace HMAC + nonce + timestamp**.
9. Replay for mismatches: **internal delivery replay only**.
10. Case actions (replay/resolve): **owner/admin only**.
11. PII in reconciliation UI: **masked by default**.

## 4) Target User Experience

## 4.1 Pro/Team without downstream callback configured (2-way active)
Users get:
- provider vs receipt vs delivery status,
- missing receipts/delivery failures,
- replay tools where applicable.

Users see:
- coverage badge: `2-way active`,
- explicit notice: “Downstream activation status not configured.”

No downstream activation mismatch claims in this mode.

## 4.2 Pro/Team with callback configured (3-way active)
Users get:
- full three-way matching,
- downstream activation discrepancy detection,
- actionable case queue with replay/resolve workflow.

Users see:
- coverage badge: `3-way active`,
- case list with status and timeline.

## 5) Architecture Delta (V6.2)
Current system already has:
- ingest evidence,
- delivery reliability,
- reconciliation runner,
- signed snapshot endpoint,
- replay and audit paths.

V6.2 adds:
1. normalized downstream snapshot contract (provider/payment/state),
2. reconciliation case model and lifecycle,
3. three-way classifier with grace window,
4. dedicated case APIs and UI.

## 6) Data Model Changes (DB Owner)

## 6.1 New table: `payment_reconciliation_cases`
Core columns:
- `id`, `workspace_id`, `provider`, `provider_payment_id`
- `status` (`open`, `pending`, `resolved`, `ignored`)
- `severity`, `reason_code`
- `first_detected_at`, `last_seen_at`, `grace_until`
- `resolved_at`, `resolved_by`, `resolution_note`
- `masked_customer_label`, `amount_minor`, `currency`
- timestamps

Constraints/indexes:
- unique/open-case guard to prevent duplicate active cases,
- fast lookup by `(workspace_id, provider, provider_payment_id)`,
- index for status + recency.

## 6.2 New table: `payment_reconciliation_case_events`
Append-only timeline:
- `id`, `case_id`, `event_type`, `details_json`, `actor_id`, `created_at`.

No update/delete for non-service roles.

## 6.3 Extend `destination_state_snapshots`
Required fields:
- `provider`,
- `provider_payment_id`,
- `downstream_state` (`activated|not_activated|error`),
- `observed_at`.

Optional:
- `reason_code`,
- `captured_data` (non-PII policy).

Indexes:
- `(workspace_id, provider, provider_payment_id, observed_at desc)`.

## 6.4 Security/immutability rules
- snapshots append-only,
- case events append-only,
- case row updates restricted to controlled status transitions and resolution metadata,
- preserve existing legal hold / evidentiary immutability semantics.

## 7) API/Contract Changes (Backend Owner)

## 7.1 Update `POST /api/reconciliation/state-snapshots`
Snapshot item schema becomes normalized and strict:
- `target_id`
- `provider`
- `provider_payment_id`
- `downstream_state`
- `observed_at`
- `state_hash`
- `reason_code?`
- `captured_data?`

Signed callback mode remains (HMAC + nonce + timestamp replay protection).
Manual owner/admin mode remains.

## 7.2 Update `POST /api/ops/reconciliation/run`
Three-way matcher computes:
- `missing_receipts`
- `missing_deliveries`
- `downstream_not_activated`
- `downstream_error`
- `failed_verifications`
- `provider_mismatches`
- `provider_pull_failures`

15-min grace applies before opening confirmed downstream mismatch case.

## 7.3 Update `GET /api/reconciliation/summary`
Include:
- coverage mode counts (2-way vs 3-way workspaces if tracked),
- open/pending/resolved case totals,
- downstream discrepancy counters.

## 7.4 Add case APIs
- `GET /api/reconciliation/cases`
- `GET /api/reconciliation/cases/:id`
- `POST /api/reconciliation/cases/:id/replay`
- `POST /api/reconciliation/cases/:id/resolve`

Auth:
- list/detail: workspace members entitled for reconciliation,
- replay/resolve: owner/admin only.

## 8) Entitlements and Gating (Payments + Backend)
Update canonical matrix (`lib/plan.ts`):
- `canUseReconciliation = true` for `pro` and `team`.
Keep governance flags Team-only:
- `canUseSso`, `canUseScim`, `canUseAccessReviews`, `canUseSlaIncidents`, `canUseLegalHold`, `canRotateKeys`, `canViewAuditLogs`.

## 9) Frontend Work (Frontend Owner)

1. Reconciliation coverage indicator:
   - `2-way active` or `3-way active`.

2. Enforced 2-way message:
   - “Downstream activation status not configured.”

3. Reconciliation case list:
   - reason/status/provider payment ID,
   - masked customer label,
   - amount/currency,
   - last seen / grace countdown.

4. Case detail:
   - timeline events,
   - linked receipt/delivery context,
   - replay + resolve actions for owner/admin.

5. Plan UX:
   - Free: visible-but-locked reconciliation surfaces,
   - Pro/Team: enabled.

6. Copy safety:
   - no settlement/downstream guarantee claims.

## 10) Matching Logic (Implementation Spec)

Canonical identity:
- `(workspace_id, provider, provider_payment_id)`.

Classification:
1. `downstream_unconfigured` (2-way mode): downstream callback not configured.
2. `pending_activation` (3-way): not activated but within 15-min grace.
3. `confirmed_missing_activation` (3-way): still not activated after grace.
4. `delivery_failure`: receipt exists, delivery unresolved/failed.
5. `provider_no_receipt`: provider object exists, no LanceIQ receipt in window.

Case lifecycle:
- create on confirmed mismatch,
- append events for replay/result/state changes,
- resolve manually or auto-resolve when reconciled.

## 11) Test Plan

## 11.1 Unit tests
- classifier outputs across 2-way and 3-way modes,
- grace-window boundary behavior,
- case transition rules.

## 11.2 API tests
- snapshot schema validation,
- callback signature/timestamp/nonce replay protections,
- Pro/Team allow, Free deny,
- owner/admin enforcement for replay/resolve.

## 11.3 Integration tests
- provider+receipt+delivery+snapshot happy path,
- mismatch creation and later auto/manual resolve,
- replay action event logging + audit trail.

## 11.4 Security tests
- stale timestamp rejected,
- nonce replay rejected,
- masked PII assertions in case responses.

## 12) Rollout Plan
1. Merge DB + backend behind feature flag.
2. Internal workspace validation for false-positive rate.
3. Enable Pro + Team gradually.
4. Enable alerts tied to confirmed case creation.
5. Monitor:
   - case volume,
   - pending→confirmed ratio,
   - replay success rate,
   - callback auth failure rate.

## 13) Documentation Updates Required
Must update after implementation:
- `ARCHITECTURE.md`
- `CONTRACTS.md`
- `DECISIONS.md`
- `STATUS.md`

## 14) Done Criteria
V6.2 is complete when:
1. Pro and Team have reconciliation access.
2. 2-way mode never overclaims downstream mismatch.
3. 3-way mode creates actionable, auditable cases.
4. Replay/resolve actions are role-safe and audited.
5. Tests pass for gating, logic, and callback security.
